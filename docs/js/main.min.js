/**
 * @license rxcomp-store v1.0.0-beta.10
 * (c) 2020 Luca Zampetti <lzampetti@gmail.com>
 * License: MIT
 */
!function(t,e,n,o){"use strict";function r(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function i(t,e,n){return e&&r(t.prototype,e),n&&r(t,n),t}function u(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,t.__proto__=e}var s=function(){function t(){}return t.clear=function(){this.isLocalStorageSupported()&&localStorage.clear()},t.delete=function(t){this.isLocalStorageSupported()&&localStorage.removeItem(t)},t.exist=function(t){return!!this.isLocalStorageSupported()&&void 0!==localStorage.getItem(t)},t.get=function(t){var e=null;if(this.isLocalStorageSupported())try{var n=localStorage.getItem(t);null!=n&&(e=JSON.parse(n))}catch(e){console.log("LocalStorageService.get.error parsing",t,e)}return e},t.set=function(t,e){if(this.isLocalStorageSupported())try{var n=new Map,o=JSON.stringify(e,(function(t,e){if("object"==typeof e&&null!==e){if(n.has(e))return;n.set(e,!0)}return e}));localStorage.setItem(t,o)}catch(n){console.log("LocalStorageService.set.error serializing",t,e,n)}},t.isLocalStorageSupported=function(){if(this.supported)return!0;var t=!1;try{(t="localStorage"in window&&null!==localStorage)?(localStorage.setItem("test","1"),localStorage.removeItem("test")):t=!1}catch(e){t=!1}return this.supported=t,t},t}();s.supported=!1;var a=function(){function t(){}return t.clear=function(){this.isSessionStorageSupported()&&sessionStorage.clear()},t.delete=function(t){this.isSessionStorageSupported()&&sessionStorage.removeItem(t)},t.exist=function(t){return!!this.isSessionStorageSupported()&&void 0!==sessionStorage.getItem(t)},t.get=function(t){var e=null;if(this.isSessionStorageSupported())try{var n=sessionStorage.getItem(t);null!=n&&(e=JSON.parse(n))}catch(e){console.log("SessionStorageService.get.error parsing",t,error)}return e},t.set=function(t,e){if(this.isSessionStorageSupported())try{var n=new Map,o=JSON.stringify(e,(function(t,e){if("object"==typeof e&&null!==e){if(n.has(e))return;n.set(e,!0)}return e}));sessionStorage.setItem(t,o)}catch(n){console.log("SessionStorageService.set.error serializing",t,e,n)}},t.isSessionStorageSupported=function(){if(this.supported)return!0;var t=!1;try{(t="sessionStorage"in window&&null!==sessionStorage)?(sessionStorage.setItem("test","1"),sessionStorage.removeItem("test")):t=!1}catch(e){t=!1}return this.supported=t,t},t}();a.supported=!1;var c,p=[],l=[],f=function(t){function e(){return t.apply(this,arguments)||this}return u(e,t),e}(t.Module);function d(t){return function(e){var n;return t.state=function(o){o.error=null,n=e(o),o.busy=!1,t.type===c.Local&&s.set(t.key,o),t.type===c.Session&&a.set(t.key,o)},n}}function g(t){return function(e){return t.state=function(t){t.error=e,t.busy=!1},n.of()}}f.meta={declarations:[].concat(p,l),exports:[].concat(p,l)},function(t){t[t.Memory=1]="Memory",t[t.Session=2]="Session",t[t.Local=3]="Local"}(c||(c={}));var h=function(){function t(t,o,r){void 0===t&&(t={}),void 0===o&&(o=c.Memory),void 0===r&&(r="store"),this.type=o,this.key="rxcomp_"+r,t.busy=!1,t.error=null;var i=new n.BehaviorSubject(t);this.setState=function(t){return function(n){t.next(e.produce(t.getValue(),(function(t){return"function"==typeof n&&n(t),t})))}}(i),this.state$=i.asObservable()}return t.prototype.setState=function(t){},i(t,[{key:"state",set:function(t){this.setState(t)}}]),t}();var S,m,y,v=0,b=function(){function t(){}return t.load$=function(t){return n.of(new Array(1).fill(0).map((function(t,e){var n=(new Date).valueOf()+e;return{id:n,name:v+++" item "+n}}))).pipe(o.delay(300*Math.random()))},t.addItem$=function(t,e){var r=(new Date).valueOf();return Math.random()<.25?n.of(1).pipe(o.delay(300*Math.random()),o.switchMap((function(){return n.throwError("error "+r)}))):n.of({id:r,name:v+++" item "+r}).pipe(o.delay(300*Math.random()))},t.remove$=function(t,e){return n.of(e).pipe(o.delay(300*Math.random()))},t.patch$=function(t,e){return n.of(e).pipe(o.delay(300*Math.random()))},t}(),$=(S={todolist:[]},m=c.Session,{busy:function(){return function(t){return n.of(null).pipe(o.filter((function(){var e;return t.state=function(t){(e=t.busy)||(t.busy=!0,t.error=null)},!e})))}(y)},getState:function(t){return function(t,e){return n.of(null).pipe(o.map((function(){var n=null;return t.type===c.Local?(n=s.get(t.key))&&"function"==typeof e&&(n=e(n)):t.type===c.Session&&(n=a.get(t.key))&&"function"==typeof e&&(n=e(n)),n})),o.filter((function(t){return null!==t})))}(y,t)},setState:d(y=new h(S,m,"todolist")),setError:g(y),state$:y.state$}),I=$.state$,M=$.busy,w=$.getState,L=$.setState,C=$.setError,k=function(){function t(){}return t.loadWithCache$=function(){return M().pipe(o.switchMap((function(){return n.merge(w((function(t){return t.todolist})),b.load$("url")).pipe(o.tap((function(t){return L((function(e){return e.todolist=t}))})),o.catchError((function(t){return C(t)})))})))},t.load$=function(){return M().pipe(o.switchMap((function(){return b.load$("url").pipe(o.tap((function(t){return L((function(e){return e.todolist=t}))})),o.catchError((function(t){return C(t)})))})))},t.addItem$=function(){return M().pipe(o.switchMap((function(){return b.addItem$("url").pipe(o.tap((function(t){return L((function(e){e.todolist.push(t)}))})),o.catchError((function(t){return C(t)})))})))},t.removeItem$=function(t){return M().pipe(o.switchMap((function(){return b.remove$("url",t).pipe(o.tap((function(t){return L((function(e){var n=e.todolist.reduce((function(e,n,o){return n.id===t?o:e}),-1);-1!==n&&e.todolist.splice(n,1)}))})),o.catchError((function(t){return C(t)})))})))},t.toggleCompleted$=function(t){return M().pipe(o.switchMap((function(){return b.patch$("url",t).pipe(o.tap((function(t){return L((function(e){var n=e.todolist.find((function(e){return e.id===t.id}));n&&(n.completed=!n.completed)}))})),o.catchError((function(t){return C(t)})))})))},i(t,null,[{key:"state$",get:function(){return I}}]),t}(),x=0,O=function(e){function n(){return e.apply(this,arguments)||this}u(n,e);var r=n.prototype;return r.onInit=function(){var e=this;t.getContext(this).node.classList.add("init"),k.state$.pipe(o.takeUntil(this.unsubscribe$)).subscribe((function(t){e.todolist=t.todolist,e.error=t.error,e.busy=t.busy,e.pushChanges(),console.log("call",x++)})),k.loadWithCache$().pipe(o.first()).subscribe(console.log)},r.onToggle=function(t){k.toggleCompleted$(t).subscribe(console.log)},r.addItem=function(){k.addItem$().subscribe(console.log)},r.removeItem=function(t){k.removeItem$(t).subscribe(console.log)},n}(t.Component);O.meta={selector:"[app-component]"};var E=function(t){function e(){return t.apply(this,arguments)||this}return u(e,t),e.prototype.onInit=function(){var t=this;k.state$.pipe(o.takeUntil(this.unsubscribe$)).subscribe((function(e){t.todolist=e.todolist,t.pushChanges()}))},e}(t.Component);E.meta={selector:"counter-component",template:'#items <span [innerHTML]="todolist.length"></span>'};var j=function(e){function n(){return e.apply(this,arguments)||this}return u(n,e),n.prototype.onChanges=function(){t.getContext(this).node.innerHTML=this.debug?JSON.stringify(this.debug,null,2):this.debug},n}(t.Component);j.meta={selector:"[debug-component]",inputs:["debug"]};var J=function(t){function e(){return t.apply(this,arguments)||this}return u(e,t),e}(t.Module);J.meta={imports:[t.CoreModule,f],declarations:[E,j],bootstrap:O},t.Browser.bootstrap(J)}(rxcomp,immer,rxjs,rxjs.operators);
//# sourceMappingURL=main.min.js.map